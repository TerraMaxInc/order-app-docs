---
title: "HubSpot Service"
format: html
---

The **HubSpot Service** is the intermediary that connects the user-facing [Ordering App](../ordering-app/ordering-app.html) to the [HubSpot Accout](../../hubspot/hubspot-overview.qmd). Because a client application isn't sufficiently secure to hold the `hubspot api token`, a backend service was needed to manage authentication and API requests securely.

This is a Node.js app written in Typescript, and hosted in [Azure Functions](azure-functions.html).  It makes heavy use of the environmental variables in Azure Functions.  

## Environmental Variables
Environmental variables store important padd data separately from the code for two main reasons:
    - **Security**: sentitive information like API tokens should not be hard-coded where it can be exposed.
    - **Configurability**: values that might change over time, like email addresses, can be updated without modifying and redeploying code.

The HubSpot Sercive uses two sets of these variables, depending on the location:
    - A local `.env` file for developement
    - Azure functions environmental variables for production

This is the full list of environmental variables found in Azure that correspond of variables in the .env file:

## Email Settings:
The app uses these variables to control who is notified when an order is submitted.

| Variable | Purpose |
|:---------|:--------|
| **TARGET_EMAIL** | Primary recipient who will process the order when closed/won. |
| **MANAGER_EMAILS** | CSV list of additional recipients who should be notified when an order is closed/won, beyond the "TARGET_EMAIL". |
| **ADMIN_EMAIL** | Filters out test orders sent by the 
administrator from from being emailed to the TARGET or MANAGERS. |
| **SENDER_EMAIL** | Email address that appears as the sender of automated emails sent by the app. |
 
## Authentication and Environment Settings

| Variable | Purpose |
|:---------|:--------|
| **AZURE_FUNCTIONS_ENVIRONMENT** | Tells the app whetherit's running in "Production" or "Development". |
| **AZURE_SQL_CONNECTION_STRING** | Gives credentials and connection information to access the [SQL database](../terramax-data/terramax-data.html). |
| **CLIENT_ID** | Identifies the registered Azure app.  This must match the Application (client) ID of the [terramax-hubspot-service-registration](hubspot-service-registration.html) in Entra, or else authentication will fail. |
| **CLIENT_SECRET** | Secret key used to authenticate the backend (terramax-hubspot-service) directly to Microsoft Graph using @application-permission.  Needed in order to send emails from a fixed address independent of who calls the api.  Secret needs to be updated every six months, and the current one will expire on **8/30/25**. |
| **HUBSPOT_API_TOKEN** | Token used to authenticate API requests to TerraMax's HubSpot account. |
| **TENANT_ID** | @tenant-id identifies the TerraMax Microsoft tenant for authentication purposes. |

## System Settings:
These variables were auto-generated by Azure and do not appear in the .env file:

- **APPINSIGHTS_INSTRUMENTATIONKEY** - Key for sending telemetry data to Azure Application Insights.
- **APPLICATIONINSIGHTS_CONNECTION_STRING** - Connection string for the Application Insights resource.
- **AzureWebJobsStorage** - Storage account used internally by Azure Functions (for function state).
- **FUNCTIONS_EXTENSION_VERSION** - Specifies the version of the Azure Functions runtime.
- **FUNCTIONS_WORKER_RUNTIME** - Defines the language worker used ("node" for Node.js apps).
- **MICROSOFT_PROVIDER_AUTHENTICATION_SECRET** - Secret used internally for Microsoft authentication flows.
- **WEBSITE_AUTH_AAD_ALLOWED_TENANTS** - Lists tenants allowed to authenticate if AAD authentication is enabled.
- **WEBSITE_NODE_DEFAULT_VERSION** - Specifies the Node.js version used by the app.
- **WEBSITE_RUN_FROM_PACKAGE** - Indicates whether the app is deployed via a package file.


## Other settings

